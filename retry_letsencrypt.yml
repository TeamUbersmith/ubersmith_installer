---

  - hosts: local
    any_errors_fatal: true

    vars:
      ubersmith_home: "{{ lookup('ini', 'ubersmith_home section=ubersmith_installer file={{ ansible_user_dir }}/.ubersmith_installer.ini') }}"
      virtual_host: "{{ lookup('ini', 'virtual_host section=ubersmith_installer file={{ ansible_user_dir }}/.ubersmith_installer.ini') }}"
      admin_email: "{{ lookup('ini', 'admin_email section=ubersmith_installer file={{ ansible_user_dir }}/.ubersmith_installer.ini'') }}"
      ubersmith_installed_version: "{{ lookup('ini', 'ubersmith_installed_version section=ubersmith_installer file={{ ansible_user_dir }}/.ubersmith_installer.ini'') }}"
      notify_email: "{{ admin_email }}"
      interactive: true

    pre_tasks:

      - name: Check for .ubersmith_installer.ini
        stat:
          path: "{{ ansible_user_dir }}/.ubersmith_installer.ini"
        register: installer_config
        tags:
          - certbot

      - name: Fail if installer configuration is not present  
        fail:
          msg: "Ubersmith installer configuration file is not present, please run configure.sh"
        when: not installer_config.stat.exists
        tags:
          - certbot

      - name: stop ubersmith web container
        community.docker.docker_compose:
          project_src: "{{ ubersmith_home }}"
          project_name: ubersmith
          stopped: yes
          services:
            - web
        tags:
          - certbot

    post_tasks:

      - name: start ubersmith web container
        community.docker.docker_compose:
          project_src: "{{ ubersmith_home }}"
          project_name: ubersmith
          stopped: no
          services:
            - web
        tags:
          - certbot

    roles:
      - ubersmith
